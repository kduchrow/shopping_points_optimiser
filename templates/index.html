{% extends "base.html" %} {% block title %}Shopping Points Optimiser{% endblock
%} {% block content %}
<div class="card medium">
  <h1>ğŸ’° Shopping Points Optimiser</h1>

  <form method="post" action="/evaluate">
    <div class="form-group">
      <label>ğŸ“Š Modus wÃ¤hlen:</label>
      <div class="mode-toggle">
        <button
          type="button"
          class="mode-btn active"
          data-mode="shopping"
          onclick="selectMode('shopping')"
        >
          <span class="icon">ğŸ’³</span>
          <span>Einkaufs-Szenario (nach Betrag)</span>
        </button>
        <button
          type="button"
          class="mode-btn"
          data-mode="voucher"
          onclick="selectMode('voucher')"
        >
          <span class="icon">ğŸ</span>
          <span>Gutschein erzeugen (benÃ¶tigter Umsatz)</span>
        </button>
        <button
          type="button"
          class="mode-btn"
          data-mode="contract"
          onclick="selectMode('contract')"
        >
          <span class="icon">âœï¸</span>
          <span>Vertragsabschluss (einmalige Punkte)</span>
        </button>
      </div>
      <div style="display: none">
        <input
          type="radio"
          id="mode-shopping"
          name="mode"
          value="shopping"
          checked
        />
        <input type="radio" id="mode-voucher" name="mode" value="voucher" />
        <input type="radio" id="mode-contract" name="mode" value="contract" />
      </div>
    </div>

    <div id="shop-warning" class="warning" style="display: none">
      âš ï¸ Dieser Shop unterstÃ¼tzt diesen Modus nicht. Bitte wÃ¤hlen Sie einen
      anderen Modus oder Shop.
    </div>

    <div class="form-group">
      <label>ğŸª Shop wÃ¤hlen:</label>
      <div class="shop-picker">
        <div class="shop-search">
          <input
            type="search"
            id="shop-search-input"
            placeholder="Shop suchen oder tippen..."
            oninput="filterShopOptions()"
          />
          <button
            type="button"
            aria-label="Suche zurÃ¼cksetzen"
            onclick="resetShopSearch()"
          >
            âœ–
          </button>
        </div>
        <div class="shop-meta" id="shop-meta">Alle Shops</div>
        <select name="shop" id="shop-select" required onchange="updateUI()">
          <option value="">-- Shop auswÃ¤hlen --</option>
          {% for shop in shops_data %}
          <option
            value="{{ shop.id }}"
            data-supports-shopping="{{ shop.supports_shopping|lower }}"
            data-supports-voucher="{{ shop.supports_voucher|lower }}"
            data-supports-contract="{{ shop.supports_contract|lower }}"
          >
            {{ shop.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div id="shopping-fields" class="input-fields" style="display: block">
      <label>ğŸ’µ Betrag:</label>
      <div class="input-group">
        <input
          type="number"
          step="0.01"
          name="amount"
          id="amount"
          placeholder="100.00"
          min="0"
          inputmode="decimal"
        />
        <span class="currency-symbol">â‚¬</span>
      </div>
    </div>

    <div id="voucher-fields" class="input-fields" style="display: none">
      <label>ğŸ« Gutschein-Betrag:</label>
      <div class="input-group">
        <input
          type="number"
          step="0.01"
          name="voucher"
          id="voucher"
          placeholder="50.00"
          min="0"
          inputmode="decimal"
        />
        <span class="currency-symbol">â‚¬</span>
      </div>
    </div>

    <div id="contract-fields" class="input-fields" style="display: none">
      <div class="contract-info">
        â„¹ï¸ Bei Abschluss eines Vertrages mit diesem Shop erhÃ¤ltst du einmalige
        Bonuspunkte pro Programm. Klicke "Berechnen" um die Gegenwerte zu sehen.
      </div>
    </div>

    <button type="submit" id="submit-btn">ğŸ” Berechnen</button>
  </form>
</div>
{% endblock %} {% block scripts %}
<script>
  function selectMode(mode) {
    const radio = document.getElementById(`mode-${mode}`);
    if (radio) {
      radio.checked = true;
    }
    document.querySelectorAll(".mode-btn").forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.mode === mode);
    });
    updateUI();
  }

  function updateUI() {
    const checked = document.querySelector('input[name="mode"]:checked');
    const mode = checked ? checked.value : "shopping";
    const shopSelect = document.getElementById("shop-select");
    const selectedShopId = shopSelect.value;

    document.getElementById("shopping-fields").style.display =
      mode === "shopping" ? "block" : "none";
    document.getElementById("voucher-fields").style.display =
      mode === "voucher" ? "block" : "none";
    document.getElementById("contract-fields").style.display =
      mode === "contract" ? "block" : "none";

    if (mode === "shopping") {
      document.getElementById("amount").required = true;
      document.getElementById("voucher").required = false;
    } else if (mode === "voucher") {
      document.getElementById("amount").required = false;
      document.getElementById("voucher").required = true;
    } else {
      document.getElementById("amount").required = false;
      document.getElementById("voucher").required = false;
    }

    const options = shopSelect.querySelectorAll('option:not([value=""])');
    let hasCompatibleShop = false;

    options.forEach((option) => {
      const supportsMode =
        option.getAttribute(`data-supports-${mode}`) === "true";
      option.style.display = supportsMode ? "block" : "none";
      if (supportsMode) hasCompatibleShop = true;
    });

    if (selectedShopId) {
      const selectedOption = shopSelect.querySelector(
        `option[value="${selectedShopId}"]`,
      );
      if (selectedOption && selectedOption.style.display === "none") {
        shopSelect.value = "";
        document.getElementById("shop-warning").style.display = "block";
      } else {
        document.getElementById("shop-warning").style.display = "none";
      }
    }

    document.getElementById("submit-btn").disabled =
      !selectedShopId || !hasCompatibleShop;
  }

  function filterShopOptions() {
    const input = document.getElementById("shop-search-input");
    const select = document.getElementById("shop-select");
    const meta = document.getElementById("shop-meta");
    if (!input || !select) return;

    const query = input.value.trim().toLowerCase();
    let visible = 0;

    Array.from(select.options).forEach((opt, idx) => {
      if (idx === 0) {
        opt.hidden = false;
        return;
      }
      const text = (opt.textContent || "").toLowerCase();
      const match = !query || text.includes(query);
      opt.hidden = !match;
      if (match) visible += 1;
    });

    if (select.value) {
      const selected = select.selectedOptions[0];
      if (selected && selected.hidden) {
        select.value = "";
        updateUI();
      }
    }

    if (meta) {
      if (query && visible === 0) {
        meta.textContent = "Keine Shops gefunden";
      } else if (query) {
        meta.textContent = `${visible} Treffer`;
      } else {
        meta.textContent = `Alle Shops (${Math.max(
          select.options.length - 1,
          0,
        )})`;
      }
    }
  }

  function resetShopSearch() {
    const input = document.getElementById("shop-search-input");
    if (input) {
      input.value = "";
    }
    filterShopOptions();
  }

  document.addEventListener("DOMContentLoaded", () => {
    selectMode("shopping");
    filterShopOptions();
  });

  updateUI();
</script>
{% endblock %}
