<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Admin - Shopping Points Optimiser</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
      .header { background-color: #007bff; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
      .header h1 { margin: 0; font-size: 24px; }
      .notification-badge { background-color: #f44336; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px; margin-left: 10px; }
      .container { max-width: 1400px; margin: 20px auto; }
      
      /* Tab Navigation */
      .tabs { background-color: white; border-radius: 8px 8px 0 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .tab-nav { display: flex; background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; }
      .tab-button { flex: 1; padding: 15px 20px; background-color: transparent; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #495057; transition: all 0.3s; }
      .tab-button:hover { background-color: #e9ecef; }
      .tab-button.active { background-color: white; color: #007bff; border-bottom: 3px solid #007bff; margin-bottom: -2px; }
      .tab-content { display: none; padding: 20px; background-color: white; border-radius: 0 0 8px 8px; }
      .tab-content.active { display: block; }
      
      /* Cards */
      .card { background-color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .card-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
      
      /* Buttons */
      .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px; transition: all 0.3s; }
      .btn-primary { background-color: #007bff; color: white; }
      .btn-primary:hover { background-color: #0056b3; }
      .btn-success { background-color: #28a745; color: white; }
      .btn-success:hover { background-color: #218838; }
      .btn-danger { background-color: #dc3545; color: white; }
      .btn-danger:hover { background-color: #c82333; }
      .btn-warning { background-color: #ffc107; color: #333; }
      .btn-warning:hover { background-color: #e0a800; }
      
      /* Notifications */
      .notification-list { list-style: none; padding: 0; margin: 0; }
      .notification-item { padding: 15px; border-bottom: 1px solid #dee2e6; cursor: pointer; transition: background-color 0.3s; }
      .notification-item:hover { background-color: #f8f9fa; }
      .notification-item.unread { background-color: #e7f3ff; font-weight: bold; }
      .notification-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 5px; }
      .notification-message { font-size: 13px; color: #666; }
      .notification-time { font-size: 11px; color: #999; margin-top: 5px; }
      
      /* Shop Merge Proposals */
      .proposal-item { padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 15px; }
      .proposal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .proposal-shops { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
      .shop-badge { background-color: #e9ecef; padding: 8px 12px; border-radius: 5px; font-size: 13px; }
      .merge-arrow { color: #007bff; font-size: 20px; }
      
      /* Rate Review */
      .rate-item { padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 15px; }
      .rate-header { display: flex; justify-content: space-between; align-items: center; }
      .rate-info { flex: 1; }
      .rate-actions { display: flex; gap: 10px; }
      .comment-box { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
      .comment-input { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 10px; resize: vertical; }
      
      /* Job Progress */
      .job-progress { background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #4caf50; display: none; }
      .job-progress.active { display: block; }
      .progress-bar { width: 100%; height: 25px; background-color: #ddd; border-radius: 4px; overflow: hidden; margin: 10px 0; }
      .progress-fill { height: 100%; background-color: #4caf50; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; }
      .job-messages { background-color: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 13px; font-family: monospace; }
      .job-status { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
      .job-status.running { background-color: #ffc107; color: #333; }
      .job-status.completed { background-color: #4caf50; color: white; }
      .job-status.failed { background-color: #f44336; color: white; }
      .job-status.queued { background-color: #2196f3; color: white; }
      
      /* Empty State */
      .empty-state { text-align: center; padding: 40px; color: #999; }
      .empty-state-icon { font-size: 48px; margin-bottom: 10px; }
      
      /* Badge */
      .badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; }
      .badge-pending { background-color: #ffc107; color: #333; }
      .badge-approved { background-color: #28a745; color: white; }
      .badge-rejected { background-color: #dc3545; color: white; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üõ†Ô∏è Admin Panel</h1>
      <div>
        <span>üë§ {{ current_user.username }}</span>
        <span class="notification-badge" id="unread-badge" style="display: none;">0</span>
        <a href="/" style="color: white; margin-left: 20px; text-decoration: none;">üè† Home</a>
        <a href="/logout" style="color: white; margin-left: 10px; text-decoration: none;">üö™ Logout</a>
      </div>
    </div>
    
    <div class="container">
      <div class="tabs">
        <div class="tab-nav">
          <button class="tab-button active" onclick="switchTab('scrapers')">ü§ñ Scrapers</button>
          <button class="tab-button" onclick="switchTab('merges')">üîó Shop Merges</button>
          <button class="tab-button" onclick="switchTab('rates')">‚≠ê Rate Review</button>
          <button class="tab-button" onclick="switchTab('notifications')">üîî Notifications</button>
        </div>
        
        <!-- Scrapers Tab -->
        <div id="tab-scrapers" class="tab-content active">
          <div class="card">
            <div class="card-title">Run Scrapers</div>
            
            <div id="job-progress" class="job-progress">
              <h3>Job Status: <span id="job-status" class="job-status">RUNNING</span></h3>
              <div class="progress-bar">
                <div id="progress-fill" class="progress-fill">0%</div>
              </div>
              <h4>Messages:</h4>
              <div id="job-messages" class="job-messages"></div>
            </div>
            
            <form id="miles-and-more-form" style="display: inline;">
              <button type="submit" class="btn btn-warning">‚úàÔ∏è Run Miles & More Scraper</button>
            </form>
            
            <form id="payback-form" style="display: inline;">
              <button type="submit" class="btn btn-warning">üí≥ Run Payback Scraper</button>
            </form>
          </div>
        </div>
        
        <!-- Shop Merges Tab -->
        <div id="tab-merges" class="tab-content">
          <div class="card">
            <div class="card-title">Pending Shop Merge Proposals</div>
            <div id="merge-proposals-list"></div>
          </div>
        </div>
        
        <!-- Rate Review Tab -->
        <div id="tab-rates" class="tab-content">
          <div class="card">
            <div class="card-title">Rates Needing Review</div>
            <div id="rates-list"></div>
          </div>
        </div>
        
        <!-- Notifications Tab -->
        <div id="tab-notifications" class="tab-content">
          <div class="card">
            <div class="card-title">
              Your Notifications
              <button class="btn btn-primary" onclick="markAllAsRead()" style="float: right;">Mark All as Read</button>
            </div>
            <ul id="notifications-list" class="notification-list"></ul>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      // Tab switching
      function switchTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
        
        // Load data when switching to specific tabs
        if (tabName === 'merges') loadMergeProposals();
        if (tabName === 'rates') loadRatesForReview();
        if (tabName === 'notifications') loadNotifications();
      }
      
      // Notification badge update
      function updateNotificationBadge() {
        fetch('/api/notifications/unread_count')
          .then(r => r.json())
          .then(data => {
            const badge = document.getElementById('unread-badge');
            if (data.unread_count > 0) {
              badge.textContent = data.unread_count;
              badge.style.display = 'inline-block';
            } else {
              badge.style.display = 'none';
            }
          });
      }
      
      // Load notifications
      function loadNotifications() {
        fetch('/api/notifications')
          .then(r => r.json())
          .then(data => {
            const list = document.getElementById('notifications-list');
            list.innerHTML = '';
            
            if (data.notifications.length === 0) {
              list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No notifications</p></div>';
              return;
            }
            
            data.notifications.forEach(n => {
              const li = document.createElement('li');
              li.className = 'notification-item' + (n.is_read ? '' : ' unread');
              li.onclick = () => markAsRead(n.id);
              
              const time = new Date(n.created_at).toLocaleString();
              li.innerHTML = `
                <div class="notification-title">${n.title}</div>
                <div class="notification-message">${n.message}</div>
                <div class="notification-time">${time}</div>
              `;
              list.appendChild(li);
            });
            
            updateNotificationBadge();
          });
      }
      
      function markAsRead(notificationId) {
        fetch(`/api/notifications/${notificationId}/read`, { method: 'POST' })
          .then(() => loadNotifications());
      }
      
      function markAllAsRead() {
        fetch('/api/notifications/read_all', { method: 'POST' })
          .then(() => loadNotifications());
      }
      
      // Load merge proposals
      function loadMergeProposals() {
        fetch('/admin/shops/merge_proposals')
          .then(r => r.json())
          .then(data => {
            const list = document.getElementById('merge-proposals-list');
            list.innerHTML = '';
            
            if (data.proposals.length === 0) {
              list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No pending merge proposals</p></div>';
              return;
            }
            
            data.proposals.forEach(p => {
              const div = document.createElement('div');
              div.className = 'proposal-item';
              div.innerHTML = `
                <div class="proposal-header">
                  <span>Proposed by: <strong>${p.proposed_by}</strong></span>
                  <span style="font-size: 12px; color: #999;">${new Date(p.created_at).toLocaleString()}</span>
                </div>
                <div class="proposal-shops">
                  <div class="shop-badge">${p.variant_a.source}: ${p.variant_a.name}</div>
                  <span class="merge-arrow">‚Üí</span>
                  <div class="shop-badge">${p.variant_b.source}: ${p.variant_b.name}</div>
                </div>
                <div style="margin: 10px 0; font-size: 13px; color: #666;"><strong>Reason:</strong> ${p.reason || 'No reason provided'}</div>
                <div>
                  <button class="btn btn-success" onclick="approveMerge(${p.id})">‚úì Approve</button>
                  <button class="btn btn-danger" onclick="rejectMerge(${p.id})">‚úó Reject</button>
                </div>
              `;
              list.appendChild(div);
            });
          });
      }
      
      function approveMerge(proposalId) {
        if (!confirm('Are you sure you want to approve this merge?')) return;
        
        fetch(`/admin/shops/merge_proposal/${proposalId}/approve`, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              alert('Merge approved successfully!');
              loadMergeProposals();
            } else {
              alert('Error: ' + data.error);
            }
          });
      }
      
      function rejectMerge(proposalId) {
        const reason = prompt('Reason for rejection:');
        if (!reason) return;
        
        fetch(`/admin/shops/merge_proposal/${proposalId}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              alert('Merge rejected');
              loadMergeProposals();
            } else {
              alert('Error: ' + data.error);
            }
          });
      }
      
      // Load rates for review
      function loadRatesForReview() {
        // This would load rates with low confidence or flagged for review
        // For now, show placeholder
        const list = document.getElementById('rates-list');
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚≠ê</div><p>Rate review coming soon...</p></div>';
      }
      
      // Scraper forms
      document.getElementById('miles-and-more-form').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/admin/run_miles_and_more', { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.job_id) {
              startJobMonitoring(data.job_id);
            }
          });
      });
      
      document.getElementById('payback-form').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/admin/run_payback', { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            if (data.job_id) {
              startJobMonitoring(data.job_id);
            }
          });
      });
      
      // Job monitoring
      let jobId = null;
      let pollInterval = null;
      
      function startJobMonitoring(id) {
        jobId = id;
        document.getElementById('job-progress').classList.add('active');
        pollInterval = setInterval(updateJobStatus, 500);
        updateJobStatus();
      }
      
      function updateJobStatus() {
        if (!jobId) return;
        
        fetch(`/admin/job_status/${jobId}`)
          .then(r => r.json())
          .then(data => {
            document.getElementById('job-status').textContent = data.status.toUpperCase();
            document.getElementById('job-status').className = `job-status ${data.status}`;
            document.getElementById('progress-fill').style.width = `${data.progress_percent}%`;
            document.getElementById('progress-fill').textContent = `${data.progress_percent}%`;
            
            const messagesDiv = document.getElementById('job-messages');
            messagesDiv.innerHTML = '';
            data.messages.slice(-10).forEach(msg => {
              const msgEl = document.createElement('div');
              msgEl.textContent = `[${msg.timestamp.substr(11, 8)}] ${msg.message}`;
              messagesDiv.appendChild(msgEl);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if (data.status === 'completed' || data.status === 'failed') {
              clearInterval(pollInterval);
              if (data.status === 'completed') {
                setTimeout(() => location.reload(), 2000);
              }
            }
          });
      }
      
      // Initialize
      updateNotificationBadge();
      setInterval(updateNotificationBadge, 30000); // Update every 30s
    </script>
  </body>
</html>
