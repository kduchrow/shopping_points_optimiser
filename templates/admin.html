{% extends "base.html" %} {% block title %}Admin - Shopping Points Optimiser{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
{% endblock %} {% block nav %}
<nav class="top-nav">
  <span class="flex-1 text-muted">ğŸ‘¤ {{ current_user.username }}</span>
  <span class="notification-badge hidden mr-10" id="unread-badge">0</span>
  <a class="nav-link" href="/">ğŸ  Startseite</a>
  <a class="nav-link" href="/logout">ğŸšª Logout</a>
</nav>
{% endblock %} {% block content %}
<div class="card wide">
  <h1>ğŸ› ï¸ Admin Panel</h1>

  <div class="admin-tabs">
    <div class="tab-nav">
      <button class="tab-button active" data-tab="scrapers" onclick="switchTab('scrapers', event)">ğŸ¤– Scrapers</button>
      <button class="tab-button" data-tab="shops" onclick="switchTab('shops', event)">ğŸ¬ Shops</button>
      <button class="tab-button" data-tab="users" onclick="switchTab('users', event)">ğŸ‘¥ Users</button>
      <button class="tab-button" data-tab="merges" onclick="switchTab('merges', event)">ğŸ”— Shop Merges</button>
      <button class="tab-button" data-tab="metadata" onclick="switchTab('metadata', event)">âœï¸ Metadaten</button>
      <button class="tab-button" data-tab="rates" onclick="switchTab('rates', event)">â­ Rate Review</button>
      <button class="tab-button" data-tab="notifications" onclick="switchTab('notifications', event)">
        ğŸ”” Notifications
        <span id="notification-badge" class="notification-badge" style="display: none">0</span>
      </button>
      <a href="/admin/scheduled_jobs" class="tab-button" style="text-decoration: none"> â° Scheduled Jobs </a>
    </div>

    <!-- Scrapers Tab -->
    <div id="tab-scrapers" class="tab-content active">
      <div class="admin-card">
        <h3>Run Scrapers</h3>

        <div id="job-progress" class="job-progress">
          <h4>Job Status: <span id="job-status" class="job-status">READY</span></h4>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill">0%</div>
          </div>
          <h5>Messages:</h5>
          <div id="job-messages" class="job-messages"></div>
        </div>

        <form id="miles-and-more-form" style="display: inline">
          <button type="submit" class="btn btn-warning">âœˆï¸ Run Miles & More Scraper</button>
        </form>

        <form id="payback-form" style="display: inline">
          <button type="submit" class="btn btn-warning">ğŸ’³ Run Payback Scraper</button>
        </form>
      </div>
    </div>

    <!-- Shops Tab -->
    <div id="tab-shops" class="tab-content">
      <div class="admin-card">
        <h3>Shop Ãœbersicht</h3>
        <input
          id="shop-search"
          type="text"
          placeholder="Suche nach Shop..."
          style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid var(--border); border-radius: 10px"
        />
        <div id="shop-list"></div>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border)" />
        <div style="padding-top: 15px">
          <h4>Verwaltung</h4>
          <button onclick="clearAllShops()" class="btn btn-danger">ğŸ—‘ï¸ Alle Shops clearen</button>
          <p style="font-size: 12px; color: #6b7280; margin-top: 10px">
            LÃ¶scht ALLE Shops (ShopMain, ShopVariant, Shop, Rates). Komplett bereinigen der Datenbank.
          </p>

          <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border)" />
          <h4>Datenpflege</h4>
          <button onclick="rescoreVariants()" class="btn btn-inline">ğŸ” Shop-Varianten neu bewerten</button>
          <p style="font-size: 12px; color: #6b7280; margin-top: 8px">
            FÃ¼hrt eine Neuberechnung der <strong>confidence_score</strong> fÃ¼r alle Shop-Varianten durch.
          </p>
          <div id="rescore-result" style="margin-top: 10px; font-family: monospace; color: #374151"></div>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="tab-content">
      <div class="admin-card">
        <h3>User Verwaltung</h3>
        <p style="margin-bottom: 15px; color: #4b5563">
          Hier kÃ¶nnen Sie User-Rollen verwalten und Accounts aktivieren/deaktivieren.
        </p>
        <a href="/admin/users" class="btn btn-inline">ğŸ‘¥ Zur User-Ãœbersicht</a>
      </div>
    </div>

    <!-- Shop Merges Tab -->
    <div id="tab-merges" class="tab-content">
      <div class="admin-card">
        <h3>Pending Shop Merge Proposals</h3>
        <div id="merge-proposals-list"></div>
      </div>
    </div>

    <!-- Metadata Tab -->
    <div id="tab-metadata" class="tab-content">
      <div class="admin-card">
        <h3>Pending Shop Metadata Proposals</h3>
        <div id="metadata-proposals-list"></div>
      </div>
    </div>

    <!-- Rate Review Tab -->
    <div id="tab-rates" class="tab-content">
      <div class="admin-card">
        <h3>Rates Needing Review</h3>
        <div id="rates-list"></div>
      </div>
    </div>

    <!-- Notifications Tab -->
    <div id="tab-notifications" class="tab-content">
      <div class="admin-card">
        <h3>Your Notifications</h3>
        <button class="btn btn-inline" onclick="markAllAsRead()" style="margin-bottom: 15px">Mark All as Read</button>
        <ul id="notifications-list" class="notification-list"></ul>
      </div>
    </div>
  </div>
</div>

<style>
  .admin-tabs {
    margin-top: 20px;
  }
  .tab-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--border);
  }
  .tab-button {
    padding: 12px 16px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #6b7280;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .tab-button.active {
    color: var(--brand-primary);
    border-bottom-color: var(--brand-primary);
  }
  .tab-button:hover {
    color: var(--brand-primary);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .admin-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .job-progress {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid var(--brand-primary);
  }
  .progress-bar {
    height: 24px;
    background: #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
    margin: 10px 0;
  }
  .progress-fill {
    height: 100%;
    background: var(--brand-primary);
    width: 0%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
    transition: width 0.3s ease;
  }
  .job-status {
    font-weight: 700;
    color: var(--brand-primary);
  }
  .job-messages {
    background: #fff;
    padding: 10px;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
    color: #4b5563;
  }
  .notification-list {
    list-style: none;
    padding: 0;
  }
  .notification-badge {
    display: inline-block;
    background: #dc3545;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
  }
</style>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
  async function rescoreVariants() {
    const target = document.getElementById('rescore-result');
    target.textContent = 'â³ Starte Neuberechnung...';
    try {
      const resp = await fetch('/admin/variants/rescore', {
        method: 'POST',
        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      if (!resp.ok) {
        const text = await resp.text();
        target.textContent = `âŒ Fehler: ${resp.status} ${text}`;
        return;
      }
      const data = await resp.json();
      // Erwartete Felder: total, improved, unchanged, skipped
      const summary = [
        `âœ… Fertig. Insgesamt: ${data.total ?? '?'}`,
        `â¬†ï¸ Verbessert: ${data.improved ?? '?'}`,
        `â– UnverÃ¤ndert: ${data.unchanged ?? '?'}`,
        `â­ï¸ Ãœbersprungen: ${data.skipped ?? 0}`
      ].join(' | ');
      target.textContent = summary;
    } catch (e) {
      target.textContent = `âŒ Fehler beim Abruf: ${e}`;
    }
  }
</script>
{% endblock %}
