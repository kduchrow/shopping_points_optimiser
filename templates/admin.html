{% extends "base.html" %}
{% block title %}Admin - Shopping Points Optimiser{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
{% endblock %}
{% block nav %}
  <nav class="top-nav">
    {% if current_user.is_authenticated %}
      <a class="nav-link" href="/profile">ğŸ‘¤ {{ current_user.username }}</a>
      {% if current_user.role == 'admin' %}
        <a class="nav-link active" href="/admin">âš™ï¸ Admin</a>
      {% endif %}
      {% if current_user.role in ['user', 'contributor', 'moderator', 'admin'] %}
        <a class="nav-link" href="/proposals">ğŸ“ BeitrÃ¤ge</a>
      {% endif %}
      <a class="nav-link" href="/">ğŸ  Home</a>
      <a class="nav-link" href="/logout">ğŸšª Logout</a>
    {% else %}
      <a class="nav-link" href="/">ğŸ  Home</a>
      <a class="nav-link" href="/login">ğŸ” Login</a>
      <a class="nav-link" href="/register">ğŸ“ Registrieren</a>
    {% endif %}
  </nav>
{% endblock %}
{% block content %}
<main class="md-main">
  <h1 class="md-headline">Admin Dashboard</h1>
  <div class="md-tabs">
    <div class="tab-nav">
      <button class="tab-button active" data-tab="tab-scrapers" type="button" aria-controls="tab-scrapers">Scrapers</button>
      <button class="tab-button" data-tab="tab-programs" type="button" aria-controls="tab-programs">Bonusprogramme</button>
      <button class="tab-button" data-tab="tab-shops" type="button" aria-controls="tab-shops">Shops auflisten</button>
      <button class="tab-button" data-tab="tab-merges" type="button" aria-controls="tab-merges">Shops bearbeiten</button>
      <button class="tab-button" data-tab="tab-users" type="button" aria-controls="tab-users">Users</button>
      <button class="tab-button" data-tab="tab-metadata" type="button" aria-controls="tab-metadata">Metadaten</button>
      <button class="tab-button" data-tab="tab-rates" type="button" aria-controls="tab-rates">Rate Review</button>
      <button class="tab-button" data-tab="tab-notifications" type="button" aria-controls="tab-notifications">Notifications <span id="notification-badge" class="notification-badge" style="display: none">0</span></button>
      <button class="tab-button" data-tab="tab-scheduled-jobs" type="button" aria-controls="tab-scheduled-jobs">Scheduled Jobs</button>
    </div>
    <div id="tab-scrapers" class="tab-content active">
      <div class="admin-card">
        <h2 class="section-title">Scraper Jobs</h2>
        <div class="scraper-jobs-view">
          <div class="scraper-btn-row">
            <form id="miles-and-more-form">
              <button type="submit" class="btn btn-warning">âœˆï¸ Run Miles & More Scraper</button>
            </form>
            <form id="payback-form">
              <button type="submit" class="btn btn-warning">ğŸ’³ Run Payback Scraper</button>
            </form>
            <form id="topcashback-form">
              <button type="submit" class="btn btn-warning">ğŸ·ï¸ Run TopCashback Scraper</button>
            </form>
            <form id="shoop-form">
              <button type="submit" class="btn btn-warning">ğŸ›’ Run Shoop Scraper</button>
            </form>
            <form id="letyshops-form">
              <button type="submit" class="btn btn-warning">ğŸ§¾ Run LetyShops Scraper</button>
            </form>
            <form id="and-charge-form">
              <button type="submit" class="btn btn-warning">ğŸš— Run &Charge Scraper</button>
            </form>
          </div>
          <div class="job-progress-card">
            <div class="job-progress-header">
              <h4 style="margin: 0;">Job Status</h4>
              <span id="job-status" class="job-status">READY</span>
            </div>
          </div>
          <div class="admin-card" style="margin-top: 18px;">
            <h3 class="section-title">Konsolidierte JSON importieren</h3>
            <form id="consolidated-import-form" enctype="multipart/form-data">
              <div class="form-group">
                <label for="consolidated-file">Datei auswÃ¤hlen</label>
                <input type="file" id="consolidated-file" name="file" accept="application/json" required />
              </div>
              <button type="submit" class="btn btn-primary">ğŸ” Vorschau laden</button>
            </form>
            <div id="consolidated-preview" style="margin-top: 12px; display: none;">
              <p><strong>Programm:</strong> <span id="consolidated-program">â€”</span></p>
              <p><strong>Shops erkannt:</strong> <span id="consolidated-shop-count">0</span></p>
              <button id="consolidated-confirm" class="btn btn-success" disabled>âœ… Import starten</button>
            </div>
          </div>
          <div class="admin-card" style="margin-top: 18px;">
            <h3 class="section-title">Coupons importieren (Strict)</h3>
            <form id="coupon-import-form" enctype="multipart/form-data">
              <div class="form-group">
                <label for="coupon-file">Datei auswÃ¤hlen</label>
                <input type="file" id="coupon-file" name="file" accept="application/json" required />
              </div>
              <button type="submit" class="btn btn-primary">ğŸ” Vorschau laden</button>
            </form>
            <div id="coupon-preview" style="margin-top: 12px; display: none;">
              <p><strong>Programm:</strong> <span id="coupon-program">â€”</span></p>
              <p><strong>Coupons erkannt:</strong> <span id="coupon-count">0</span></p>
              <div id="coupon-missing" style="margin-top: 8px; display: none;">
                <p><strong>Fehlende Programme:</strong> <span id="coupon-missing-programs">â€”</span></p>
                <p><strong>Fehlende Shops:</strong> <span id="coupon-missing-shops">â€”</span></p>
              </div>
              <div id="coupon-import-feedback" style="margin-top: 8px; display: none;"></div>
              <div id="coupon-table-wrapper" style="margin-top: 12px;"></div>
              <button id="coupon-confirm" class="btn btn-success" disabled>âœ… Coupon-Import starten</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="tab-programs" class="tab-content">
      <div class="admin-card">
        <h2 class="section-title">Bonusprogramme Management</h2>
        <div class="programs-section">
          <h3>Neue Programm hinzufÃ¼gen</h3>
          <form action="/admin/add_program" method="POST" class="program-form">
            <div class="form-group">
              <label for="program-name">Programm Name:</label>
              <input type="text" id="program-name" name="name" required placeholder="z.B. Miles & More" />
            </div>
            <div class="form-group">
              <label for="program-value">Punkwertigkeit (â‚¬):</label>
              <input type="number" id="program-value" name="point_value_eur" step="0.001" min="0" value="0.01" required />
            </div>
            <button type="submit" class="btn btn-success">â• Programm hinzufÃ¼gen</button>
          </form>
        </div>
        <hr />
        <div class="programs-section">
          <h3>Bestehende Programme</h3>
          <div id="programs-list"></div>
        </div>
      </div>
    </div>
    <div id="tab-shops" class="tab-content">
      <div class="admin-card">
        <h2 class="section-title">Shop Management</h2>
        <div class="shop-filter-row">
          <input id="shop-search" type="text" placeholder="Suche nach Shop..." class="shop-search-input" />
          <select id="bonus-program-filter" class="shop-bonus-filter">
            <option value="">Alle Bonusprogramme</option>
          </select>
          <label style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
            <input type="checkbox" id="show-deleted-shops" />
            <span>GelÃ¶schte anzeigen</span>
          </label>
          <button id="delete-program-shops" class="btn btn-danger shop-delete-btn" disabled title="WÃ¤hle ein Bonusprogramm zum LÃ¶schen"> Programm Shops lÃ¶schen</button>
        </div>
        <div id="shop-paging" class="shop-paging"></div>
        <hr class="shop-hr" />
        <div style="display: flex; gap: 12px; margin-top: 18px;">
          <button class="btn btn-danger" onclick="clearAllShops()">ğŸ—‘ï¸ Alle Shops lÃ¶schen</button>
          <button class="btn btn-warning" onclick="deleteAllMetadata()">ğŸ—‘ï¸ Alle Metadaten-AntrÃ¤ge lÃ¶schen</button>
        </div>
        <div class="shop-list-wrapper" style="margin-top: 24px;">
          <div id="shop-list"></div>
        </div>
      </div>
    </div>
    <div id="tab-users" class="tab-content">
      <div class="admin-card">
        <h2 class="section-title">User Management</h2>

        <h4>Alle registrierten User ({{ users|length }})</h4>

        {% if users|length > 0 %}
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Rolle</th>
              </div>
              <th>Registriert</th>
              <th>Aktionen</th>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td><strong>{{ user.username }}</strong></td>
              <td>{{ user.email }}</td>
              <td>
                <span class="role-badge role-{{ user.role }}">{{ user.role }}</span>
              </td>
              <td>
                <span class="status-badge status-{{ user.status }}">{{ user.status }}</span>
              </td>
              <td>{{ user.created_at.strftime('%d.%m.%Y') }}</td>
              <td>
                <form action="/admin/users/{{ user.id }}/update_role" method="POST" class="action-form">
                  <select name="role" onchange="this.form.submit()">
                    <option value="">Rolle Ã¤ndern...</option>
                    <option value="viewer" {% if user.role == "viewer" %}disabled{% endif %}>Viewer</option>
                    <option value="user" {% if user.role == "user" %}disabled{% endif %}>User</option>
                    <option value="contributor" {% if user.role == "contributor" %}disabled{% endif %}>Contributor</option>
                    <option value="moderator" {% if user.role == "moderator" %}disabled{% endif %}>Moderator</option>
                    <option value="admin" {% if user.role == "admin" %}disabled{% endif %}>Admin</option>
                  </select>
                </form>
                <form
                  action="/admin/users/{{ user.id }}/toggle_status"
                  method="POST"
                  class="action-form"
                  onsubmit="return confirm('Status von {{ user.username }} wirklich Ã¤ndern?');"
                >
                  {% if user.status == 'active' %}
                  <button type="submit" class="btn btn-sm btn-warning">ğŸ”’ Deaktivieren</button>
                  {% else %}
                  <button type="submit" class="btn btn-sm btn-success">âœ… Aktivieren</button>
                  {% endif %}
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-state">
          <p>Keine User gefunden.</p>
        </div>
        {% endif %}

        <h4 class="mt-30">â„¹ï¸ Rollen-ErklÃ¤rung</h4>
        <ul class="line-height-1-8 pl-20">
          <li><strong>Viewer:</strong> Kann nur Ã¶ffentliche Inhalte sehen</li>
          <li><strong>User:</strong> Kann Proposals erstellen</li>
          <li><strong>Contributor:</strong> Kann Proposals erstellen und Ã¼ber Proposals abstimmen</li>
          <li><strong>Moderator:</strong> Kann Raten einsehen</li>
          <li><strong>Admin:</strong> Volle Rechte (User-Verwaltung, Scrapers, Proposals direkt genehmigen)</li>
        </ul>
      </div>
    </div>
    <div id="tab-merges" class="tab-content">
      <div class="admin-card">
        <h2 class="section-title">Shops bearbeiten</h2>

        <h3>Merge Proposals</h3>
        <div id="merge-proposals-list"></div>

        <hr style="margin: 32px 0;" />

        <h3>Shop Varianten Verwalten</h3>
        <p style="color: #666; margin-bottom: 16px;">
          WÃ¤hle einen Shop aus, um dessen Varianten zu sehen und zu bearbeiten.
        </p>

        <div style="margin-bottom: 24px;">
          <input
            id="shop-variant-search"
            type="text"
            placeholder="Suche Shop..."
            class="shop-search-input"
            style="width: 400px; margin-bottom: 12px;"
          />
          <div id="shop-variant-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <div id="shop-variant-details" style="display: none;">
          <h4 id="selected-shop-name" style="margin-bottom: 6px;"></h4>
          <div id="selected-shop-id" style="margin-bottom: 16px; color: #666; font-size: 12px; word-break: break-all;"></div>
          <div id="variant-selection-container"></div>
          <div style="margin-top: 16px; display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">
            <div style="min-width: 320px;">
              <input
                id="new-shop-name"
                type="text"
                placeholder="Name fÃ¼r neuen Shop..."
                style="padding: 8px; width: 300px; margin-right: 12px;"
              />
              <button class="btn btn-warning" onclick="splitShopVariants()">
                AusgewÃ¤hlte Varianten in neuen Shop splitten
              </button>
            </div>
            <div style="min-width: 320px;">
              <input
                id="target-shop-main-id"
                type="text"
                placeholder="Ziel-ShopMain ID (UUID)"
                style="padding: 8px; width: 300px; margin-right: 12px;"
              />
              <button class="btn btn-primary" onclick="moveVariantsToExistingShop()">
                Varianten zu bestehendem Shop verschieben
              </button>
            </div>
            <button
              class="btn btn-danger"
              onclick="deleteShop()"
              style="margin-left: auto;"
              title="Shop lÃ¶schen (Soft Delete - setzt Status auf 'deleted')">
              Shop lÃ¶schen
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="tab-metadata" class="tab-content">
      <div class="admin-card">
        <h2 class="section-title">Metadaten</h2>
        <div id="metadata-proposals-list"></div>
      </div>
    </div>
    <div id="tab-rates" class="tab-content">
      <div class="admin-card">
              </div>
        <div id="rates-list"></div>
      </div>
    <div id="tab-notifications" class="tab-content">
        <button class="btn btn-inline" onclick="markAllAsRead()" style="margin-bottom: 15px">Mark All as Read</button>
        <ul id="notifications-list" class="notification-list"></ul>
    </div>
    <div id="tab-scheduled-jobs" class="tab-content">
        <div id="scheduled-jobs-dynamic"></div>
        <div class="cron-examples">
          <h3>ğŸ’¡ Cron Expression Beispiele</h3>
          <ul>
            <li><code>0 2 * * *</code> - TÃ¤glich um 2:00 Uhr</li>
            <li><code>0 */6 * * *</code> - Alle 6 Stunden</li>
            <li><code>0 0 * * 0</code> - Jeden Sonntag um Mitternacht</li>
            <li><code>*/15 * * * *</code> - Alle 15 Minuten</li>
            <li><code>0 3 1 * *</code> - Am 1. jeden Monats um 3:00 Uhr</li>
          </ul>
          <p class="text-muted">
            Format: <code>Minute Stunde Tag Monat Wochentag</code>
            <br />
            <a href="https://crontab.guru/" target="_blank">Crontab Generator â†’</a>
          </p>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
// Bonusprogramme laden
function loadBonusPrograms() {
  const programsList = document.getElementById('programs-list');
  const programs = {{ programs|tojson }};

  if (!programs || programs.length === 0) {
    programsList.innerHTML = '<p class="empty-state">Keine Bonusprogramme vorhanden.</p>';
    return;
  }

  let html = '<table class="admin-table"><thead><tr><th>ID</th><th>Programm & Wertigkeit</th><th>Aktionen</th></tr></thead><tbody>';

  programs.forEach(program => {
    html += `
      <tr>
        <td>${program.id}</td>
        <td>
          <form action="/admin/program/${program.id}" method="POST" class="program-edit-form">
            <input type="text" name="name" value="${program.name}" required placeholder="Name" />
            <input type="number" name="point_value_eur" step="0.001" min="0" value="${program.point_value_eur}" required placeholder="â‚¬0.00" />
            <button type="submit" class="btn btn-sm btn-primary">ğŸ’¾</button>
          </form>
        </td>
        <td>
          <form action="/admin/program/${program.id}/delete" method="POST" class="inline-form" style="display:inline;" onsubmit="return confirm('Programm "${program.name}" wirklich lÃ¶schen?');">
            <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ï¸</button>
          </form>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table>';
  programsList.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', function() {
  loadBonusPrograms();
  var showBtn = document.getElementById('show-create-job-form');
  var form = document.getElementById('create-job-form');
  var cancelBtn = document.getElementById('cancel-create-job');
  if (showBtn && form && cancelBtn) {
    showBtn.addEventListener('click', function() {
      form.style.display = 'block';
      showBtn.style.display = 'none';
    });
    cancelBtn.addEventListener('click', function() {
      form.style.display = 'none';
      showBtn.style.display = 'inline-block';
    });
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var data = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        body: data
      })
      .then(async r => {
        if (r.ok) {
          form.style.display = 'none';
          showBtn.style.display = 'inline-block';
          location.reload();
        } else {
          let msg = 'Error creating job.';
          try {
            const data = await r.json();
            msg += '\n' + (data.error || '') + (data.details ? '\n' + data.details : '');
          } catch (e) {
            msg += '\n' + (await r.text());
          }
          alert(msg);
        }
      });
    });
  }
});
</script>
{% endblock %}
