{% extends "base.html" %} {% block title %}Ergebnisse - Shopping Points Optimiser{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}" />
{% endblock %} {% block nav %}
<nav class="top-nav">
  <a class="nav-link" href="/">ğŸ  Startseite</a>
</nav>
{% endblock %} {% block content %}
<div class="card wide">
  <h1>ğŸ“Š Ergebnisse</h1>

  <div class="info-box">
    <p>ğŸª <strong>Shop:</strong> {{ shop.name }}</p>
    {% if mode == 'shopping' %}
    <p>ğŸ’µ <strong>Einkaufsbetrag:</strong> {{ amount }}â‚¬</p>
    {% elif mode == 'voucher' %}
    <p>ğŸ <strong>GewÃ¼nschter Gutschein:</strong> {{ voucher }}â‚¬</p>
    {% endif %}
  </div>

  {% if mode == 'shopping' %} {% if has_coupons %}
  <div class="coupons-section">
    <h3>ğŸ‰ VerfÃ¼gbare Sonderaktionen fÃ¼r diesen Shop</h3>
    <form id="coupon-selection-form" method="post" action="/evaluate">
        <input type="hidden" name="shop" value="{{ shop.id }}" />
        <input type="hidden" name="amount" value="{{ amount }}" />
        <input type="hidden" name="mode" value="shopping" />
      <div class="coupons-list" style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 8px;">
        {% for coupon in active_coupons %}
        <div class="coupon-card" style="background: #f8fafc; border: 1px solid #e0e7ef; border-radius: 14px; padding: 18px 20px 32px 20px; min-width: 260px; max-width: 340px; box-shadow: 0 2px 8px #e0e7ef33; display: flex; flex-direction: column; align-items: flex-start; position: relative;">
          <div style="width:100%; display:flex; flex-direction:column;">
            <span style="font-weight:600; font-size:1.13em; color:#222;">{{ coupon.name }}</span>
            <span style="display:block; font-size:1em; color:#444; margin-top:4px;">
              {% if coupon.coupon_type == 'multiplier' %}ğŸ”¢ <b>{{ coupon.value|int if coupon.value == coupon.value|int else coupon.value }}x</b> Multiplikator{% else %}ğŸ’° <b>{{ coupon.value|int if coupon.value == coupon.value|int else coupon.value }}%</b> Rabatt{% endif %}
            </span>
            <span style="font-size:0.95em; color:#666; margin-top:4px;">{{ coupon.description }}</span>
            <div style="font-size:0.93em; color:#888; margin-top:8px; margin-bottom:10px;">
              {% if coupon.shop and coupon.shop.name %}
                ğŸ“ {{ coupon.shop.name }}
              {% endif %}
              <br />
              {% if coupon.program and coupon.program.name %}
                <span style="margin-left:8px;">Programm: {{ coupon.program.name }}</span>
              {% endif %}
            </div>
          </div>
          <div style="width:100%; display:flex; justify-content:center; align-items:center; margin-top:auto;">
            <label for="coupon-{{ coupon.id }}" style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:1em;">
              <span style="font-size:0.97em; color:#555;">Aktivieren</span>
              <input type="checkbox" name="coupon_ids" value="{{ coupon.id }}" class="coupon-tickbox styled-tickbox" id="coupon-{{ coupon.id }}" {% if coupon.selected %}checked{% endif %} style="accent-color:#3b82f6; width:22px; height:22px; border-radius:12px; box-shadow:0 1px 4px #3b82f633;">
            </label>
          </div>
        </div>
        {% endfor %}
      </div>
      {% if active_coupons|length > 3 %}
      <p class="text-small text-gray-light mt-8 text-center">â† Scroll fÃ¼r mehr Coupons â†’</p>
      {% endif %}
    </form>
  </div>

  <div class="warning">
    <strong>âš ï¸ Hinweis:</strong> FÃ¼r diesen Shop sind Sonderaktionen verfÃ¼gbar. Die Berechnungen berÃ¼cksichtigen diese
    automatisch.
  </div>

  <div class="mode-toggle" style="display: flex; align-items: center; gap: 16px;">
    <div>
      <button class="mode-btn active" onclick="sortResults('base', event)">ğŸ“Š Nach Basiswert</button>
      <button class="mode-btn" onclick="sortResults('coupon', event)">ğŸ‰ Mit Sonderaktionen</button>
    </div>
  </div>
  {% endif %}

  <h2>ğŸ† Beste Programme (geschÃ¤tzter Gegenwert in â‚¬)</h2>
  <ul class="results-list" id="results-list">
    {% if grouped_results is defined %}
      {% for prog in grouped_results %}
        <li data-base-value="{{ prog.categories[0].euros }}" data-coupon-value="{% set best_coupon = (prog.categories | selectattr('coupon_info', 'defined') | selectattr('coupon_info.euros', 'defined') | map(attribute='coupon_info') | list) %}{% if best_coupon and best_coupon[0] %}{{ best_coupon[0].euros }}{% else %}{{ prog.categories[0].euros }}{% endif %}">
          <div style="display: flex; align-items: flex-start; justify-content: space-between; width: 100%;">
            <div style="flex: 1 1 auto;">
              <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                <div class="program-name">{{ prog.program }}</div>
                <div class="program-value" style="margin-left: 12px; white-space: nowrap; font-size: 1.15em; font-weight: 600;">{{ prog.best_value }}â‚¬ ( {{ amount - prog.best_value }}â‚¬ ) </div>
              </div>
              <div class="program-details">
                {% if prog.categories|length > 1 %}
                  Beste Kategorie: {{ prog.best_value }}â‚¬
                {% else %}
                  Basiswert: {{ prog.categories[0].euros }}â‚¬
                {% endif %}
              </div>
              <div style="margin-top:8px;">
                <strong>Kategorien:</strong>
                <ul style="margin:6px 0 0 12px; padding:0; list-style: none;">
                  {% for c in prog.categories %}
                    <li style="padding:4px 0; border-bottom:1px solid #f3f4f6;">
                      <div style="font-weight:600; padding-left: 4px;">{{ c.category or c.sub_category or 'Allgemein' }}</div>
                      <div style="font-size:13px; color:#555">
                        {% if c.cashback is defined and c.cashback|float > 0.0 %}
                          {{ c.cashback|round(2) }}% Cashback â†’ {{ c.euros|round(2) }}â‚¬
                        {% else %}
                          {{ c.points }} Punkte â†’ {{ c.euros|round(2) }}â‚¬
                        {% endif %}
                        {% if c.coupon_info %} (Aktion: {{ c.coupon_info.euros }}â‚¬){% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </li>
      {% endfor %}
    {% else %}
      {% for r in results %}
      <li
        data-base-value="{{ r.euros }}"
        data-coupon-value="{% if r.coupon_info %}{{ r.coupon_info.euros }}{% else %}{{ r.euros }}{% endif %}"
      >
        <div class="flex-1">
          <div class="program-name">{{ r.program }}</div>
          <div class="program-details">Basiswert: {{ r.points }} Punkte â†’ {{ r.euros }}â‚¬</div>

          {% if r.coupon_info %}
          <div class="coupon-info">
            <strong>ğŸ‰ Mit Sonderaktion:</strong>
            <span class="coupon-value">{{ r.coupon_info.euros }}â‚¬</span>
            ({{ r.coupon_info.points }} Punkte) {% if r.coupon_info.multipliers %}
            <br />{{ r.coupon_info.multipliers|join(', ') }} {% endif %} {% if r.coupon_info.discounts %} <br />{{ r.coupon_info.discounts|join(', ') }} {% endif %} {% if r.coupon_info.unknown_combinability %} <br /><em style="color: #ff6600">âš  Kombinierbarkeit unbekannt - Beide Werte angezeigt</em> {% endif %}
          </div>
          {% endif %}
        </div>
        <div class="program-value" id="value-{{ r.program|replace(' ', '-') }}">{{ r.euros }}â‚¬</div>
      </li>
      {% endfor %}
    {% endif %}
  </ul>
  {% elif mode == 'voucher' %}
  <h2>ğŸ¯ BenÃ¶tigter Umsatz nach Programm</h2>
  <ul class="results-list">
    {% for r in results %}
    <li>
      <div>
        <div class="program-name">{{ r.program }}</div>
        <div class="program-details">{{ r.req_points }} Punkte benÃ¶tigt</div>
      </div>
      <div class="program-value">{{ r.spend }}â‚¬</div>
    </li>
    {% endfor %}
  </ul>
  {% elif mode == 'contract' %}
  <h2>âœï¸ Vertragsabschluss Bonuspunkte</h2>
  <div class="info-box">
    Bei Abschluss eines Vertrages mit <strong>{{ shop.name }}</strong> erhÃ¤ltst du folgende Bonuspunkte pro Programm:
  </div>
  <ul class="results-list">
    {% for r in results %}
    <li>
      <div class="program-name">{{ r.program }}</div>
    </li>
    {% endfor %}
  </ul>
  <div class="info-box mt-20">
    â„¹ï¸ Die genauen Werte und VergÃ¼tungen findest du in der
    <a href="/admin" class="text-decoration-underline"><strong>Admin-Seite</strong></a>
    unter "Shops & Raten".
  </div>
  {% endif %}

  <div class="links-stack justify-center mt-30">
    <a href="/" class="btn btn-inline btn-secondary">â† ZurÃ¼ck zur Startseite</a>
    <a href="/shop/{{ shop.id }}/suggest" class="btn btn-inline">âœï¸ Vorschlag einreichen</a>
  </div>
</div>
{% endblock %} {% block modals %}
<!-- Modal for scraper proposals -->
<div id="proposalModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeProposalModal()">&times;</span>
    <h2>ğŸ¤– Scraper-Vorschlag</h2>
    <p>FÃ¼r den Shop <strong id="modalShopName"></strong> wurde automatisch ein Vorschlag erstellt:</p>
    <p id="modalReason"></p>
    <p>
      <a id="modalSourceLink" href="#" target="_blank">ğŸ“„ Quelle anzeigen</a>
    </p>
    <div class="modal-buttons">
      <button id="reviewBtn" class="modal-btn primary">âœï¸ Vorschlag reviewen</button>
      <button onclick="closeProposalModal()" class="modal-btn secondary">âœ• SchlieÃŸen</button>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/result.js') }}"></script>
{% endblock %}
