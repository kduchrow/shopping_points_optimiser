{% extends "base.html" %} {% block title %}Ergebnisse - Shopping Points Optimiser{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}" />
{% endblock %} {% block nav %}
<nav class="top-nav">
  <a class="nav-link" href="/">ğŸ  Startseite</a>
</nav>
{% endblock %} {% block content %}
<div class="card wide">
  <h1>ğŸ“Š Ergebnisse</h1>

  <div class="info-box">
    <p>ğŸª <strong>Shop:</strong> {{ shop.name }}</p>
    {% if mode == 'shopping' %}
    <p>ğŸ’µ <strong>Einkaufsbetrag:</strong> {{ amount }}â‚¬</p>
    {% elif mode == 'voucher' %}
    <p>ğŸ <strong>GewÃ¼nschter Gutschein:</strong> {{ voucher }}â‚¬</p>
    {% endif %}
  </div>

  {% if mode == 'shopping' %} {% if has_coupons %}
  <div class="coupons-section">
    <h3>ğŸ‰ VerfÃ¼gbare Sonderaktionen fÃ¼r diesen Shop</h3>
    <div class="coupons-list">
      {% for coupon in active_coupons %}
      <div class="coupon-card">
        <h4>{{ coupon.name }}</h4>
        <div class="coupon-type">
          {% if coupon.coupon_type == 'multiplier' %} ğŸ”¢ {{ coupon.value }}x Multiplikator {% else %} ğŸ’° {{ coupon.value
          }}% Rabatt {% endif %}
        </div>
        <div class="coupon-value">
          {% if coupon.coupon_type == 'multiplier' %} Ã—{{ coupon.value }} {% else %} -{{ coupon.value }}% {% endif %}
        </div>
        <p class="text-small text-gray mt-8 mb-0">{{ coupon.description }}</p>
        <div class="coupon-shop">
          <strong>ğŸ“ {{ coupon.shop.name }}</strong>
        </div>
        {% if coupon.program %}
        <div class="coupon-program">Programm: {{ coupon.program.name }}</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% if active_coupons|length > 3 %}
    <p class="text-small text-gray-light mt-8 text-center">â† Scroll fÃ¼r mehr Coupons â†’</p>
    {% endif %}
  </div>

  <div class="warning">
    <strong>âš ï¸ Hinweis:</strong> FÃ¼r diesen Shop sind Sonderaktionen verfÃ¼gbar. Die Berechnungen berÃ¼cksichtigen diese
    automatisch.
  </div>

  <div class="mode-toggle">
    <button class="mode-btn active" onclick="sortResults('base', event)">ğŸ“Š Nach Basiswert</button>
    <button class="mode-btn" onclick="sortResults('coupon', event)">ğŸ‰ Mit Sonderaktionen</button>
  </div>
  {% endif %}

  <h2>ğŸ† Beste Programme (geschÃ¤tzter Gegenwert in â‚¬)</h2>
  <ul class="results-list" id="results-list">
    {% if grouped_results is defined %}
      {% for prog in grouped_results %}
        <li>
          <div style="display: flex; align-items: flex-start; justify-content: space-between; width: 100%;">
            <div style="flex: 1 1 auto;">
              <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                <div class="program-name">{{ prog.program }}</div>
                <div class="program-value" style="margin-left: 12px; white-space: nowrap; font-size: 1.15em; font-weight: 600;">{{ prog.best_value }}â‚¬</div>
              </div>
              <div class="program-details">
                {% if prog.categories|length > 1 %}
                  Beste Kategorie: {{ prog.best_value }}â‚¬
                {% else %}
                  Basiswert: {{ prog.categories[0].euros }}â‚¬
                {% endif %}
              </div>
              <div style="margin-top:8px;">
                <strong>Kategorien:</strong>
                <ul style="margin:6px 0 0 12px; padding:0; list-style: none;">
                  {% for c in prog.categories %}
                    <li style="padding:4px 0; border-bottom:1px solid #f3f4f6;">
                      <div style="font-weight:600; padding-left: 4px;">{{ c.category or c.sub_category or 'Allgemein' }}</div>
                      <div style="font-size:13px; color:#555">
                        {% if c.cashback_pct is defined and c.cashback_pct|float > 0 %}
                          {{ c.cashback_pct }}% Cashback â†’ {{ c.euros }}â‚¬
                        {% else %}
                          {{ c.points }} Punkte â†’ {{ c.euros }}â‚¬
                        {% endif %}
                        {% if c.coupon_info %} (Aktion: {{ c.coupon_info.euros }}â‚¬){% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </li>
      {% endfor %}
    {% else %}
      {% for r in results %}
      <li
        data-base-value="{{ r.euros }}"
        data-coupon-value="{% if r.coupon_info %}{{ r.coupon_info.euros }}{% else %}{{ r.euros }}{% endif %}"
      >
        <div class="flex-1">
          <div class="program-name">{{ r.program }}</div>
          <div class="program-details">Basiswert: {{ r.points }} Punkte â†’ {{ r.euros }}â‚¬</div>

          {% if r.coupon_info %}
          <div class="coupon-info">
            <strong>ğŸ‰ Mit Sonderaktion:</strong>
            <span class="coupon-value">{{ r.coupon_info.euros }}â‚¬</span>
            ({{ r.coupon_info.points }} Punkte) {% if r.coupon_info.multipliers %}
            <br />{{ r.coupon_info.multipliers|join(', ') }} {% endif %} {% if r.coupon_info.discounts %} <br />{{ r.coupon_info.discounts|join(', ') }} {% endif %} {% if r.coupon_info.unknown_combinability %} <br /><em style="color: #ff6600">âš  Kombinierbarkeit unbekannt - Beide Werte angezeigt</em> {% endif %}
          </div>
          {% endif %}
        </div>
        <div class="program-value" id="value-{{ r.program|replace(' ', '-') }}">{{ r.euros }}â‚¬</div>
      </li>
      {% endfor %}
    {% endif %}
  </ul>
  {% elif mode == 'voucher' %}
  <h2>ğŸ¯ BenÃ¶tigter Umsatz nach Programm</h2>
  <ul class="results-list">
    {% for r in results %}
    <li>
      <div>
        <div class="program-name">{{ r.program }}</div>
        <div class="program-details">{{ r.req_points }} Punkte benÃ¶tigt</div>
      </div>
      <div class="program-value">{{ r.spend }}â‚¬</div>
    </li>
    {% endfor %}
  </ul>
  {% elif mode == 'contract' %}
  <h2>âœï¸ Vertragsabschluss Bonuspunkte</h2>
  <div class="info-box">
    Bei Abschluss eines Vertrages mit <strong>{{ shop.name }}</strong> erhÃ¤ltst du folgende Bonuspunkte pro Programm:
  </div>
  <ul class="results-list">
    {% for r in results %}
    <li>
      <div class="program-name">{{ r.program }}</div>
    </li>
    {% endfor %}
  </ul>
  <div class="info-box mt-20">
    â„¹ï¸ Die genauen Werte und VergÃ¼tungen findest du in der
    <a href="/admin" class="text-decoration-underline"><strong>Admin-Seite</strong></a>
    unter "Shops & Raten".
  </div>
  {% endif %}

  <div class="links-stack justify-center mt-30">
    <a href="/" class="btn btn-inline btn-secondary">â† ZurÃ¼ck zur Startseite</a>
    <a href="/shop/{{ shop.id }}/suggest" class="btn btn-inline">âœï¸ Vorschlag einreichen</a>
  </div>
</div>
{% endblock %} {% block modals %}
<!-- Modal for scraper proposals -->
<div id="proposalModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeProposalModal()">&times;</span>
    <h2>ğŸ¤– Scraper-Vorschlag</h2>
    <p>FÃ¼r den Shop <strong id="modalShopName"></strong> wurde automatisch ein Vorschlag erstellt:</p>
    <p id="modalReason"></p>
    <p>
      <a id="modalSourceLink" href="#" target="_blank">ğŸ“„ Quelle anzeigen</a>
    </p>
    <div class="modal-buttons">
      <button id="reviewBtn" class="modal-btn primary">âœï¸ Vorschlag reviewen</button>
      <button onclick="closeProposalModal()" class="modal-btn secondary">âœ• SchlieÃŸen</button>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/result.js') }}"></script>
{% endblock %}
