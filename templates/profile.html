{% extends "base.html" %} {% block title %}Profil - Shopping Points Optimiser{% endblock %} {% block nav %}
<nav class="top-nav">
  <a class="nav-link" href="/">ğŸ  Startseite</a>
  {% if current_user.role in ['user', 'contributor', 'admin'] %}
  <a class="nav-link" href="/proposals">ğŸ“ BeitrÃ¤ge</a>
  <a class="nav-link" href="/proposals/new">â• Neuer Beitrag</a>
  {% endif %}
  <a class="nav-link" href="/logout">ğŸšª Logout</a>
</nav>
{% endblock %} {% block content %}
<div class="card wide">
  <h1>ğŸ‘¤ Mein Profil</h1>

  <div class="profile-section">
    <div class="profile-info">
      <div class="info-row">
        <span class="info-label">Benutzername:</span>
        <span class="info-value">{{ current_user.username }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Email:</span>
        <span class="info-value">{{ current_user.email }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Rolle:</span>
        <span class="info-value">
          <span class="role-badge role-{{ current_user.role }}"> {{ current_user.role.upper() }} </span>
        </span>
      </div>
      <div class="info-row">
        <span class="info-label">Status:</span>
        <span class="info-value">
          {% if current_user.status == 'active' %}
          <span class="status-badge status-active">âœ“ Aktiv</span>
          {% else %}
          <span class="status-badge status-inactive">âœ— Gesperrt</span>
          {% endif %}
        </span>
      </div>
    </div>
  </div>

  <h2>â­ Meine Bonusprogramme</h2>
  <div class="profile-section">
    <p style="color: #666; margin-bottom: 16px;">
      WÃ¤hle deine Bonusprogramme aus. Auf der Startseite kannst du dann filtern,
      um nur Ergebnisse fÃ¼r deine favorisierten Programme zu sehen.
    </p>
    <div id="favorite-programs-container">
      {% for program in all_programs %}
      <label class="program-checkbox">
        <input
          type="checkbox"
          name="program"
          value="{{ program.id }}"
          {% if program.id in favorite_program_ids %}checked{% endif %}
        />
        <span>{{ program.name }}</span>
      </label>
      {% endfor %}
    </div>
    <button id="save-favorites-btn" class="btn btn-primary" style="margin-top: 16px;">
      Favoriten speichern
    </button>
    <span id="save-status" style="margin-left: 12px; color: #666;"></span>
  </div>

  {% if current_user.role == 'viewer' or current_user.role == 'user' %}
  <h2>ğŸ“¢ Contributor werden</h2>
  {% if contributor_request %}
  <div class="contributor-request">
    {% if contributor_request.status == 'pending' %} â³ Ihre Anfrage ist ausstehend. Warten Sie auf die BestÃ¤tigung
    durch einen Admin. {% elif contributor_request.status == 'approved' %} âœ“ Ihre Anfrage wurde genehmigt! Sie sind
    jetzt Contributor. {% elif contributor_request.status == 'rejected' %} âœ— Ihre Anfrage wurde abgelehnt. {% endif %}
  </div>
  {% else %}
  <div class="contributor-request">
    Werden Sie Contributor, um Rate-Ã„nderungen vorzuschlagen und abzustimmen!
    <form method="post" action="/request-contributor" class="form-group">
      <button type="submit" class="btn btn-inline">Contributor-Anfrage einreichen</button>
    </form>
  </div>
  {% endif %} {% endif %} {% if current_user.role in ['user', 'contributor'] %}
  <h2>ğŸ“ Meine VorschlÃ¤ge</h2>
  {% if proposals %}
  <ul class="proposals-list">
    {% for proposal in proposals %}
    <li class="proposal-item">
      <span class="proposal-type">{{ proposal.proposal_type.upper() }}</span>
      <span class="proposal-status status-{{ proposal.status }}">{{ proposal.status.upper() }}</span>
      {% if proposal.reason %}
      <p class="proposal-reason"><strong>Grund:</strong> {{ proposal.reason }}</p>
      {% endif %}
      <p class="proposal-meta">Erstellt: {{ proposal.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="empty-message">Sie haben noch keine VorschlÃ¤ge eingereicht.</p>
  {% endif %} {% endif %}
</div>

<script>
document.getElementById('save-favorites-btn').addEventListener('click', function() {
  const checkboxes = document.querySelectorAll('input[name="program"]:checked');
  const programIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
  const statusEl = document.getElementById('save-status');

  statusEl.textContent = 'Speichere...';
  statusEl.style.color = '#666';

  fetch('/profile/favorite-programs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ program_ids: programIds })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      statusEl.textContent = `âœ“ ${data.count} Programme gespeichert`;
      statusEl.style.color = '#28a745';
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    } else {
      statusEl.textContent = 'âœ— Fehler beim Speichern';
      statusEl.style.color = '#dc3545';
    }
  })
  .catch(err => {
    statusEl.textContent = 'âœ— Fehler: ' + err.message;
    statusEl.style.color = '#dc3545';
  });
});
</script>

{% endblock %}
