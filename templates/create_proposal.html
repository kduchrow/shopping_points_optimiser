{% extends "base.html" %} {% block title %}Neuer Beitrag - Shopping Points Optimiser{% endblock %} {% block nav %}
<nav class="top-nav">
  <a class="nav-link" href="/proposals">üìù Beitr√§ge</a>
  <a class="nav-link" href="/">üè† Startseite</a>
</nav>
{% endblock %} {% block content %}
<div class="card medium">
  <h1>‚ûï Neuen Beitrag erstellen</h1>

  <div class="info-box">
    ‚ÑπÔ∏è Ihre √Ñnderungsvorschl√§ge werden von der Community gepr√ºft. Bei 3+ Upvotes wird Ihr Vorschlag automatisch
    √ºbernommen.
  </div>

  <form method="post">
    <div class="form-group">
      <label>Art des Beitrags:</label>
      <div class="type-selector">
        <div class="type-option">
          <input type="radio" id="type-rate" name="proposal_type" value="rate_change" checked onchange="updateForm()" />
          <label for="type-rate">üìä Rate √§ndern (Points/EUR oder Cashback%)</label>
        </div>
        <div class="type-option">
          <input type="radio" id="type-shop" name="proposal_type" value="shop_add" onchange="updateForm()" />
          <label for="type-shop">üè™ Neuen Shop hinzuf√ºgen</label>
        </div>
        <div class="type-option">
          <input type="radio" id="type-program" name="proposal_type" value="program_add" onchange="updateForm()" />
          <label for="type-program">üéÅ Neues Bonusprogramm hinzuf√ºgen</label>
        </div>
        <div class="type-option">
          <input type="radio" id="type-coupon" name="proposal_type" value="coupon_add" onchange="updateForm()" />
          <label for="type-coupon">üéâ Sonderaktion/Coupon hinzuf√ºgen</label>
        </div>
        <div class="type-option">
          <input type="radio" id="type-metadata" name="proposal_type" value="metadata_edit" onchange="updateForm()" />
          <label for="type-metadata">‚úèÔ∏è Shop-Metadaten √§ndern (Name/Logo/Website)</label>
        </div>
        <div class="type-option">
          <input type="radio" id="type-merge" name="proposal_type" value="merge_request" onchange="updateForm()" />
          <label for="type-merge">üîÄ Shops zusammenf√ºhren</label>
        </div>
      </div>
    </div>

    <!-- Rate Change Fields -->
    <div id="rate-change-fields" class="conditional-fields active">
      <h3>Rate-√Ñnderung</h3>

      <div class="form-group">
        <label for="shop-select">Shop:</label>
        <select id="shop-select" name="shop_id">
          <option value="">-- Shop ausw√§hlen --</option>
          {% for shop in shops %}
          <option value="{{ shop.id }}">{{ shop.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="program-select">Bonusprogramm:</label>
        <select id="program-select" name="program_id">
          <option value="">-- Programm ausw√§hlen --</option>
          {% for program in programs %}
          <option value="{{ program.id }}">{{ program.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="rate-type">Rate-Typ:</label>
        <select id="rate-type-select" name="rate_type" onchange="updateRateTypeFields()">
          <option value="cashback" selected>Cashback</option>
          <option value="points">Punkte</option>
        </select>
      </div>

      <div class="form-group">
        <label for="rate-category">Rate-Kategorie:</label>
        <select id="rate-category-select" name="rate_category">
          <option value="shop" selected>Shop</option>
          <option value="contract">Vertrag</option>
        </select>
      </div>

      <div class="form-group" id="cashback-field">
        <label for="cashback-pct">Neuer Cashback %:</label>
        <input type="number" id="cashback-pct" name="cashback_pct" step="0.01" min="0" placeholder="z.B. 2.5" />
      </div>
      <div class="form-group" id="points-field" style="display:none;">
        <label for="points-per-eur">Neue Points/EUR:</label>
        <input type="number" id="points-per-eur" name="points_per_eur" step="0.01" min="0" placeholder="z.B. 1.0" />
      </div>
    </div>

    <!-- Shop Add Fields -->
    <div id="shop-add-fields" class="conditional-fields">
      <h3>Neuer Shop</h3>

      <div class="form-group">
        <label for="shop-name">Shop-Name:</label>
        <input type="text" id="shop-name" name="shop_name" placeholder="z.B. MediaMarkt" />
      </div>
    </div>

    <!-- Program Add Fields -->
    <div id="program-add-fields" class="conditional-fields">
      <h3>Neues Bonusprogramm</h3>

      <div class="form-group">
        <label for="program-name">Programmname:</label>
        <input type="text" id="program-name" name="program_name" placeholder="z.B. Shoop" required />
      </div>

      <div class="form-group">
        <label for="program-type">Typ:</label>
        <select name="program_type" id="program-type-select" required onchange="updateProgramTypeFields()">
          <option value="">-- Typ w√§hlen --</option>
          <option value="points">Punkteprogramm</option>
          <option value="cashback">Cashback</option>
        </select>
      </div>

      <div id="points-fields" style="display:none;">
        <div class="form-group">
          <label>Wie wird der Wert berechnet?</label>
          <select name="conversion_type" id="conversion-type-select" onchange="updateConversionFields()">
            <option value="">-- Auswahl --</option>
            <option value="points_per_eur">Wie viele Punkte gibt es pro Euro?</option>
            <option value="eur_per_point">Wie viele Euro ist ein Punkt wert?</option>
          </select>
        </div>
        <div class="form-group" id="points-per-eur-field" style="display:none;">
          <label>Punkte pro Euro</label>
          <input type="number" name="points_per_eur" step="0.01" min="0" placeholder="z.B. 1.0" />
        </div>
        <div class="form-group" id="eur-per-point-field" style="display:none;">
          <label>Euro pro Punkt</label>
          <input type="number" name="eur_per_point" step="0.0001" min="0" placeholder="z.B. 0.01" />
        </div>
      </div>
    </div>

    <!-- Coupon Add Fields -->
    <div id="coupon-add-fields" class="conditional-fields">
      <h3>Sonderaktion/Coupon</h3>

      <div class="form-group">
        <label for="coupon-type">Art der Aktion:</label>
        <select id="coupon-type" name="coupon_type">
          <option value="">-- Ausw√§hlen --</option>
          <option value="multiplier">üî¢ Multiplikator (z.B. 20x Punkte)</option>
          <option value="discount">üí∞ Rabatt (z.B. 10% Rabatt)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="coupon-value">Wert (Multiplikator oder % Rabatt):</label>
        <input
          type="number"
          id="coupon-value"
          name="coupon_value"
          step="0.01"
          min="0"
          placeholder="z.B. 20 f√ºr 20x oder 10 f√ºr 10%"
        />
      </div>

      <div class="form-group">
        <label for="coupon-description">Beschreibung:</label>
        <textarea
          id="coupon-description"
          name="coupon_description"
          placeholder="z.B. '20-fach Punkte bei Einkauf ab 50‚Ç¨'"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="coupon-shop">Shop (optional - leer lassen f√ºr alle Shops):</label>
        <select id="coupon-shop" name="coupon_shop_id">
          <option value="">-- Alle Shops --</option>
          {% for shop in shops %}
          <option value="{{ shop.id }}">{{ shop.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="coupon-program">Bonusprogramm (optional - leer lassen f√ºr alle Programme):</label>
        <select id="coupon-program" name="coupon_program_id">
          <option value="">-- Alle Programme --</option>
          {% for program in programs %}
          <option value="{{ program.id }}">{{ program.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>Kombinierbar mit anderen Aktionen?</label>
        <div class="type-selector">
          <div class="type-option">
            <input type="radio" id="comb-yes" name="coupon_combinable" value="yes" />
            <label for="comb-yes">‚úì Ja</label>
          </div>
          <div class="type-option">
            <input type="radio" id="comb-no" name="coupon_combinable" value="no" />
            <label for="comb-no">‚úó Nein</label>
          </div>
          <div class="type-option">
            <input type="radio" id="comb-unknown" name="coupon_combinable" value="unknown" checked />
            <label for="comb-unknown">‚ùì Unbekannt</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="coupon-valid-to">G√ºltig bis (Datum):</label>
        <input type="date" id="coupon-valid-to" name="coupon_valid_to" />
      </div>
    </div>

    <!-- Metadata Edit Fields -->
    <div id="metadata-edit-fields" class="conditional-fields">
      <h3>Shop-Metadaten</h3>

      <div class="form-group">
        <label for="metadata-shop">Shop ausw√§hlen:</label>
        <select id="metadata-shop" name="metadata_shop_id">
          <option value="">-- Shop ausw√§hlen --</option>
          {% for shop in shops %}
          <option value="{{ shop.id }}">{{ shop.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="metadata-name">Neuer Name (optional):</label>
        <input type="text" id="metadata-name" name="metadata_name" placeholder="z.B. richtiger Markenname" />
      </div>

      <div class="form-group">
        <label for="metadata-website">Website (optional):</label>
        <input type="url" id="metadata-website" name="metadata_website" placeholder="https://..." />
      </div>

      <div class="form-group">
        <label for="metadata-logo">Logo-URL (optional):</label>
        <input type="url" id="metadata-logo" name="metadata_logo" placeholder="https://.../logo.png" />
      </div>
    </div>

    <!-- Merge Request Fields -->
    <div id="merge-request-fields" class="conditional-fields">
      <h3>Shops zusammenf√ºhren</h3>
      <div class="info-box">
        W√§hle zwei Shops, die eigentlich zusammengeh√∂ren. Beide m√ºssen bereits mit einem Hauptshop verkn√ºpft sein.
      </div>

      <div class="form-group">
        <label for="merge-source">Shop A (behalten):</label>
        <select id="merge-source" name="merge_source_shop_id">
          <option value="">-- Shop A ausw√§hlen --</option>
          {% for shop in shops %}
          <option value="{{ shop.id }}">{{ shop.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="merge-target">Shop B (zusammenf√ºhren):</label>
        <select id="merge-target" name="merge_target_shop_id">
          <option value="">-- Shop B ausw√§hlen --</option>
          {% for shop in shops %}
          <option value="{{ shop.id }}">{{ shop.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Common Fields -->
    <div class="form-group">
      <label for="reason">Begr√ºndung (optional):</label>
      <textarea id="reason" name="reason" placeholder="Warum sollte diese √Ñnderung vorgenommen werden?"></textarea>
    </div>

    <div class="form-group">
      <label for="source-url">Quelle/Link (optional):</label>
      <input type="url" id="source-url" name="source_url" placeholder="https://..." />
    </div>

    <button type="submit">‚úì Vorschlag einreichen</button>
  </form>
</div>
{% endblock %} {% block scripts %}
<script>
  function updateForm() {
    const type = document.querySelector('input[name="proposal_type"]:checked').value;
    const sections = [
      "rate-change-fields",
      "shop-add-fields",
      "program-add-fields",
      "coupon-add-fields",
      "metadata-edit-fields",
      "merge-request-fields"
    ];
    sections.forEach(function(id) {
      const section = document.getElementById(id);
      if (section) {
        section.classList.remove("active");
        // Disable all inputs in hidden sections
        Array.from(section.querySelectorAll("input, select, textarea")).forEach(function(el) {
          el.disabled = true;
        });
      }
    });
    let activeId = null;
    if (type === "rate_change") activeId = "rate-change-fields";
    else if (type === "shop_add") activeId = "shop-add-fields";
    else if (type === "program_add") activeId = "program-add-fields";
    else if (type === "coupon_add") activeId = "coupon-add-fields";
    else if (type === "metadata_edit") activeId = "metadata-edit-fields";
    else if (type === "merge_request") activeId = "merge-request-fields";
    if (activeId) {
      const activeSection = document.getElementById(activeId);
      activeSection.classList.add("active");
      // Enable all inputs in the active section
      Array.from(activeSection.querySelectorAll("input, select, textarea")).forEach(function(el) {
        el.disabled = false;
      });
    }
  }

  // Ensure correct fields are enabled on page load
  document.addEventListener("DOMContentLoaded", function() {
    updateForm();
  });

  function updateRateTypeFields() {
    var type = document.getElementById('rate-type-select').value;
    if (type === 'cashback') {
      document.getElementById('cashback-field').style.display = '';
      document.getElementById('points-field').style.display = 'none';
      document.getElementById('points-per-eur').value = '';
    } else {
      document.getElementById('cashback-field').style.display = 'none';
      document.getElementById('points-field').style.display = '';
      document.getElementById('cashback-pct').value = '';
    }
  }

  function updateProgramTypeFields() {
    var type = document.getElementById('program-type-select').value;
    document.getElementById('points-fields').style.display = (type === 'points') ? '' : 'none';
  }
  function updateConversionFields() {
    var conv = document.getElementById('conversion-type-select').value;
    document.getElementById('points-per-eur-field').style.display = (conv === 'points_per_eur') ? '' : 'none';
    document.getElementById('eur-per-point-field').style.display = (conv === 'eur_per_point') ? '' : 'none';
  }
</script>
{% endblock %}
